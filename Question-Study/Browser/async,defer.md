# async, defer 키워드

이 두 가지 키워드는 script를 비동기적으로 받아오려고 할 때,
사용하는 키워드이다.

이런 비동기적 처리가 필요한 이유 :
브라우저 html을 읽다가 script 태그를 만나면,
script 태그를 읽어온다.
그리고 script를 읽는 과정 속에서는 dom 생성이 중단된다.  
이런 이유로 비동기적으로 script를 불러오는 것이 필요하다.

script로 dom 생성이 중단되었을 때 발생할 수 있는 이슈 :  
1.스크립트에서는 스크립트 아래에 있는 DOM 요소에 접근할 수 없다. 따라서 DOM 요소에 핸들러를 추가하는 것과 같은 여러 행위가 불가능해집니다.  
2.페이지 위쪽에 용량이 큰 스크립트가 있는 경우 스크립트가 페이지를 ‘막아버린다’. 페이지에 접속하는 사용자들은 스크립트를 다운받고 실행할 때까지 스크립트 아래쪽 페이지를 볼 수 없게 된다.

## 해결책 1

script 태그를 가장 아래쪽에 놔둔다.

그러나 이것 또한 완벽한 해결책은 아니다.  
1.HTML 문서 자체가 아주 큰 경우를 가정해보자. 브라우저가 HTML 문서 전체를 다운로드 한 다음에 스크립트를 다운받게 하면 페이지가 정말 느려질 것이다.  
2.스크립트를 해석하는 도중에 사용자가 버튼을 클릭하거나 텍스트를 입력하는 것처럼 웹과 상호작용을 시도하게 된다면, 제대로 동작하지 않을 것이다. 사용자가 보이기엔 완성된 것 같지만, 백그라운드에서는 JavaScript를 해석해서 실행하는 중이기 때문이다.

다행이 이런 해결법 외에도 다른 해결 방법이 있다.  
async와 defer를 사용하는 방법이다.

## 해결책 2 - defer :

브라우저는 defer 속성이 있는 스크립트(이하 defer 스크립트 또는 지연 스크립트)를 '백그라운드’에서 다운로드 한다.(여기서 백그라운드는 어디를 말하는가? )  
따라서 지연 스크립트를 다운로드 하는 도중에도 HTML 파싱이 멈추지 않는다. 그리고 defer 스크립트 실행은 페이지 구성이 끝날 때까지 지연된다.

아래는 예시 코드이다.

```javascript
<p>...스크립트 앞 콘텐츠...</p>

<script>
  document.addEventListener('DOMContentLoaded', () => alert("`defer` 스크립트가 실행된 후, DOM이 준비되었습니다!")); // (2)
</script>

<script defer src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>

<p>...스크립트 뒤 콘텐츠...</p>
```

위 코드를 살펴보면,  
1.페이지 콘텐츠는 바로 출력된다.  
2.DOMContentLoaded 이벤트는 지연 스크립트 실행을 기다린다. 따라서 얼럿창은 DOM 트리가 완성되고 지연 스크립트가 실행된 후에 뜬다.

- 지연 스크립트는 페이지 생성을 절대 막지 않는다.
- 지연 스크립트는 DOM이 준비된 후에 실행되긴 하지만 DOMContentLoaded 이벤트 발생 전에 실행된다.

- defer 스크립트는 모든 DOM이 로드된 후에야 실행된다.

## 해결책 3 - async :

async 속성이 붙은 스크립트는 페이지와 완전히 독립적으로 동작한다.

- async 스크립트는 defer 스크립트와 마찬가지로 백그라운드에서 다운로드된다. 따라서 HTML 페이지는 async 스크립트 다운이 완료되길 기다리지 않고 페이지 내 콘텐츠를 처리, 출력합니다(하지만 async 스크립트 실행중에는 HTML 파싱이 멈춘다.)
- DOMContentLoaded 이벤트와 async 스크립트는 서로를 기다리지 않는다.
  - 페이지 구성이 끝난 후에 async 스크립트 다운로딩이 끝난 경우, DOMContentLoaded는 async 스크립트 실행 전에 발생할 수 있다.
  - async 스크립트가 짧아서 페이지 구성이 끝나기 전에 다운로드 되거나 스크립트가 캐싱처리 된 경우, DOMContentLoaded는 async 스크립트 실행 후에 발생할 수도 있다.
- 다른 스크립트들은 async 스크립트를 기다리지 않는다. async 스크립트 역시 다른 스크립트들을 기다리지 않는다.

- 비동기 스크립트 다운로드는 페이지 로딩을 막지 않기 때문에 페이지 콘텐츠가 바로 출력된다.
- DOMContentLoaded 이벤트는 상황에 따라 비동기 스크립트 전이나 후에 실행된다. 정확한 순서를 예측할 수 없다.
- 비동기 스크립트는 서로를 기다리지 않는다. 먼저 로드가 된 스크립트가 먼저 실행되는 것을 'load-first order’라고 부른다.

- 중요한 것은 async 키워드는 파일을 불러올 때만 병렬적으로 처리된다. 파일을 불러오고 나면 곧바로 실행을 시작하기 때문에 dom이 생성되던 중간에 막힐 수 있다.
- async 스크립트는 DOM에 직접 접근하지 않거나, 다른 스크립트에 의존적이지 않은 스크립트들을 독립적으로 실행해야 할 때 효과적이다.

## async 와 defer 비교분석 :

### 공통점 :

- 두가지 방법 모두 다 스크립트 다운로드시 페이지 렌더링을 막지 않는다.

### 차이점 :

- 순서 : async는 문서가 로드 된 순서로 실행되고, defer는 문서에 추가되어 있는 순서대로 실행된다.
- DOMContentLoaded : async는 html문서가 완전히 다운로드 되지 않았어도 먼저 실행될 수 있다. defer는 문서 다운로드와 파싱이 끝난 후, DOMContentLoaded실행 전 그 사이에 실행된다.

## 주의점 :

- defer를 사용하게 되면 스크립트가 실행되기 전 에 페이지가 화면에 출력된다는 점에 항상 유의해야 한다.
- 사용자는 그래픽 관련 컴포넌트들이 준비되지 않은 상태에서 화면을 보게 될 수 있다.
- 따라서 지연 스크립트가 영향을 주는 영역엔 반드시 '로딩 인디케이터’가 있어야 한다. 관련 버튼도 사용 불가(disabled) 처리를 해줘야 한다. 이렇게 해야 사용자에게 현재 어떤 것은 사용할 수 있는지, 어떤 것은 사용할 수 없는지를 알려줄 수 있다.

![async,defer]("./img/async,defer.png")
